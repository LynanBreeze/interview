## 浏览器中输入URL后发生了什么 （详解版）

### 合成URL

用户输入URL，浏览器会根据用户输入的信息判断是搜索还是网址，如果是搜索内容，就将搜索内容+默认搜索引擎合成新的URL；如果用户输入的内容符合URL规则，
浏览器就会根据URl 协议，在这段内容上加上协议合成合法的URL。

### DNS域名解析

DNS的域名查找，在客户端和浏览器，本地DNS之间的查询方式是递归查询；在本地DNS服务器与根域及其子域之间的查询方式是迭代查询；

在客户端输入URL 后，会有一个递归查找的过程，从浏览器缓存中查找 --》 本地的hosts 文件查找 --》 找本地DNS解析器缓存查找 --》本地DNS服务器查找，
这个过程中任何一步找到了都会结束查找过程。

如果本地DNS服务器无法查询到，则根据本地DNS服务器设置的转发器进行查询。若未用转发模式，则迭代查找。

### 建立TCP连接

首先，判断是不是https的，如果是，则HTTPS 其实 HTTP +  SSL / TLS  两部分组成， 也就是在 HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过SSL进行加密，所以传输的数据都是加密后的数据。

#### 三次握手

1. 主机向服务器发送一个建立连接的请求 （您好，我想认识您）
2. 服务器接到请求后发送同意连接的信号  （好的，很高兴认识您）
3. 主机接到同意连接的信号后，再次向服务器发送了确认信号（我也很高兴认识您），自此，主机与服务器两者建立了连接。

#### SSL握手

概念：SSL/TLS 负责加密通信的安全协议，建立在TCP/IP 之上，SSL 由网景公司发明，当发展到3.0时，被标准化，改名为TLS.

1. 第一步：客户端给出协议版本号，一个客户端生成的随机数（Client random），以及客户端支持的加密的方法
2. 第二步：服务器确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数 (Server random)
3. 第三步：客户端确认数字证书有效，然后生成一个新的随机数 (Premaster secret)，并使用数字证书中的公钥，加密这个随机数，发给服务端
4. 第四步：服务端使用自己的私钥，解密刚刚被客户端加密的随机数
5. 第五步：客户端和服务器端根据约定的加密方法，使用前面的三个随机数，生成“对话密钥”，用来加密接下来的整个对话过程

### 发送HTTP请求，服务器处理请求，返回响应结果

TCP 连接建立后，浏览器就可以利用HTTP/HTTPS 协议向服务器发送请求了。服务接受到请求，就解析请求头，如果头部有缓存相关信息 如 if-none-match 与
if-modified-since，则验证缓存是否有效，若有效则返回状态码为304，若无效则重新返回资源，状态码为 200.

### 关闭TCP连接，即四次挥手

客户端发送结束请求FIN =》服务器确认收到FIN请求 =》服务器发送结束返回FIN =》客户端确认收到FIN返回，断开TCP连接

1. 主机向服务器发送一个断开连接的请求 （不早了，我该走了）
2. 服务器接到请求后发送确认收到请求的信号（知道了）
3. 服务器向主机发送断开通知（我也该走了）
4. 主机接到断开通知后断开连接并反馈一个确认信号（嗯，好的），服务器收到确认信号后断开连接。

### 浏览器渲染

过程：构建DOM树 --》样式计算 --》页面布局 --》生成分层树 --》删格化 --》显示

浏览器已得到HTML数据：

1. 对HTML文本词法分析和语法分析，自上而下加载，遇到`<script src="">`和`<style href="">`此类标签，若资源指向外链，则会额外发起请求加载。

2. 渲染进程将标签内容转换成DOM树

3. 渲染引擎将CSS样式表转化为浏览器可以理解的`stylesSheets`，计算出DOM节点的样式。

> - 首先进行属性值标准化，例如：将`color: blue`转化为`color: rgb(0,0,255)`
> - 其次处理样式的继承与层叠 => 从右往左开始匹配

4. 创建`renderTree`布局树，并计算元素的布局信息。

> 结合dom tree 和样式规则，生成一颗只包含可见元素的tree。即display:none的tree并不会出现在此模型上。

5. 对布局树进行分层，并生成分层树。

> 此处考虑到页面中有很多复杂的效果，如一些复杂的3D变换、页面滚动，或者使用z-index做 z 轴排序等，为了更加方便地
> 实现这些效果，渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树（LayerTree）

6. 为每个图层生成绘制列表，并将其提交到合成线程。合成线程将图层分图块，并删格化将图块转换成位图。

> 删格化可以理解为按照图层整合出顶层视角上的显示图块。合成线程优先考虑合成视口及其附近的位图。

7. 合成线程发送绘制图块命令给浏览器进程.浏览器进程根据指令生成页面，并显示到显示器上。


[参考链接](https://github.com/impeiran/Blog/issues/3)

[参考链接](https://mp.weixin.qq.com/s/nMlZWZO6foRUPFK34ouPhg)
